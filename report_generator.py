import textwrap
import pandas as pd
import os
from google import genai

# ======================================================
# ğŸ§  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ãƒ­ã‚¸ãƒƒã‚¯
# ======================================================

def build_report_prompt(data_summary, mode: str = "customer") -> str:
    """
    ãƒ¬ãƒãƒ¼ãƒˆç¨®åˆ¥ã«å¿œã˜ãŸLLMãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚
    mode: "customer", "product", "combined"
    """
    def df_to_text(df_or_dict):
        if isinstance(df_or_dict, pd.DataFrame):
            return df_or_dict.round(2).to_markdown(index=False)
        elif isinstance(df_or_dict, dict):
            return "\n".join(f"- {k}: {v}" for k, v in df_or_dict.items())
        else:
            return str(df_or_dict)

    if mode == "customer":
        # --- é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ ---
        table_text = df_to_text(data_summary["rfm"])
        prompt = f"""
        ã‚ãªãŸã¯ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®å°‚é–€å®¶ã§ã™ã€‚
        ä»¥ä¸‹ã¯RFMåˆ†æã¨K-Meansã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹
        ã€Œé¡§å®¢ã‚¯ãƒ©ã‚¹ã‚¿åˆ¥ã®å¹³å‡æŒ‡æ¨™ã€ã§ã™ã€‚

        ãƒ†ãƒ¼ãƒ–ãƒ«:
        {table_text}

        å„åˆ—ã®æ„å‘³:
        - Recency: æœ€çµ‚è³¼å…¥ã‹ã‚‰ã®æ—¥æ•°ï¼ˆå°ã•ã„ã»ã©æœ€è¿‘è³¼å…¥ã—ã¦ã„ã‚‹ï¼‰
        - Frequency: è³¼å…¥å›æ•°
        - Monetary: ç·è³¼å…¥é‡‘é¡

        ä»¥ä¸‹ã®è¦³ç‚¹ã§æ—¥æœ¬èªã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

        1. å„ã‚¯ãƒ©ã‚¹ã‚¿ã®ç‰¹å¾´ï¼ˆã©ã®ã‚ˆã†ãªé¡§å®¢å±¤ã‹ï¼‰
        2. é‡è¦ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆï¼ˆã©ã®å±¤ãŒå£²ä¸Šã‚’æ”¯ãˆã¦ã„ã‚‹ã‹ã€é›¢è„±ãƒªã‚¹ã‚¯å±¤ã¯ã©ã“ã‹ï¼‰
        3. å„ã‚¯ãƒ©ã‚¹ã‚¿ã”ã¨ã«æ¨å¥¨ã•ã‚Œã‚‹ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ–½ç­–ï¼ˆ3ã€œ5å€‹ï¼‰
        4. å…¨ä½“ã¨ã—ã¦ã®å„ªå…ˆæˆ¦ç•¥ï¼ˆã©ã®å±¤ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’æŠ•è³‡ã™ã¹ãã‹ï¼‰

        å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
        - ã€Œ1. ã‚¯ãƒ©ã‚¹ã‚¿æ¦‚è¦ã€ã€Œ2. å„ã‚¯ãƒ©ã‚¹ã‚¿ã®ç‰¹å¾´ã€ãªã©ã®è¦‹å‡ºã—
        - ç®‡æ¡æ›¸ãä¸­å¿ƒ
        - ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ‹…å½“è€…ãŒã™ãèª­ã‚ã‚‹ã‚ˆã†ã«
        - ã§ã™ãƒ»ã¾ã™èª¿ã§æ›¸ã
        """

    elif mode == "product":
        # --- å•†å“è²©å£²äºˆæ¸¬åˆ†æ ---
        table_text = df_to_text(data_summary["forecast"])
        prompt = f"""
        ã‚ãªãŸã¯ãƒªãƒ†ãƒ¼ãƒ«æ¥­ç•Œã®ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
        ä»¥ä¸‹ã¯å•†å“ã®è²©å£²å®Ÿç¸¾ãŠã‚ˆã³äºˆæ¸¬çµæœã®é›†è¨ˆã§ã™ã€‚

        ãƒ†ãƒ¼ãƒ–ãƒ«:
        {table_text}

        å„åˆ—ã®æ„å‘³ï¼ˆä¾‹ï¼‰:
        - Product: å•†å“å
        - SalesCount: è²©å£²ä»¶æ•°
        - MAE / RMSE / RÂ²: äºˆæ¸¬ç²¾åº¦æŒ‡æ¨™

        ä»¥ä¸‹ã®è¦³ç‚¹ã§æ—¥æœ¬èªã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

        1. å£²ã‚Œç­‹ãƒ»ä¸æŒ¯å•†å“ã®å‚¾å‘ã‚’è¦ç´„
        2. ä»Šå¾Œã®éœ€è¦ãŒä¼¸ã³ãã†ãªã‚«ãƒ†ã‚´ãƒªãƒ»å•†å“
        3. æ”¹å–„ãŒå¿…è¦ãªå•†å“ç¾¤ï¼ˆè²©å£²æˆ¦ç•¥ãƒ»ä¾¡æ ¼ãƒ»åœ¨åº«ãªã©ã®ç¤ºå”†ï¼‰
        4. çŸ­æœŸãƒ»ä¸­æœŸã®è²©å£²æˆ¦ç•¥ææ¡ˆ

        å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
        - ã€Œ1. å£²ä¸Šå‚¾å‘ã€ã€Œ2. éœ€è¦äºˆæ¸¬ã€ã€Œ3. æˆ¦ç•¥ææ¡ˆã€ãªã©ã®è¦‹å‡ºã—
        - ç®‡æ¡æ›¸ãä¸­å¿ƒã€ç°¡æ½”ã«
        - ã§ã™ãƒ»ã¾ã™èª¿ã§æ›¸ã
        """

    elif mode == "combined":
        # --- é¡§å®¢ï¼‹å•†å“ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ ---
        rfm_text = df_to_text(data_summary["rfm"])
        forecast_text = df_to_text(data_summary["forecast"])
        prompt = f"""
        ã‚ãªãŸã¯ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒªãƒ–ãƒ³ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®å°‚é–€å®¶ã§ã™ã€‚
        ä»¥ä¸‹ã¯é¡§å®¢åˆ†æï¼ˆRFMã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ï¼‰ã¨å•†å“è²©å£²äºˆæ¸¬ã®çµæœã§ã™ã€‚

        ã€é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ¦‚è¦ã€‘
        {rfm_text}

        ã€å•†å“è²©å£²äºˆæ¸¬æ¦‚è¦ã€‘
        {forecast_text}

        ä»¥ä¸‹ã®è¦³ç‚¹ã§ã€æ—¥æœ¬èªã®çµ±åˆãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

        1. é¡§å®¢å±¤ã¨å•†å“è²©å£²å‚¾å‘ã®é–¢é€£æ€§ï¼ˆä¾‹: é«˜ä¾¡å€¤é¡§å®¢ã¯ã©ã®ã‚«ãƒ†ã‚´ãƒªã‚’è³¼å…¥ã—ã¦ã„ã‚‹ã‹ï¼‰
        2. é¡§å®¢ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã®è²©å£²æˆ¦ç•¥ææ¡ˆ
        3. ä»Šå¾Œã®é‡ç‚¹æ–½ç­–ï¼ˆã‚¯ãƒ­ã‚¹ã‚»ãƒ«ï¼ã‚¢ãƒƒãƒ—ã‚»ãƒ«ï¼åœ¨åº«æœ€é©åŒ–ï¼‰
        4. å…¨ä½“æˆ¦ç•¥ï¼ˆåç›Šæœ€å¤§åŒ–ã®ãŸã‚ã®æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

        å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
        - ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ã¨ç®‡æ¡æ›¸ãã‚’ç”¨ã„ãŸãƒ¬ãƒãƒ¼ãƒˆ
        - ãƒ“ã‚¸ãƒã‚¹ææ¡ˆæ›¸ãƒ¬ãƒ™ãƒ«ã®è‡ªç„¶ãªèªã‚Šå£ï¼ˆã§ã™ãƒ»ã¾ã™èª¿ï¼‰
        """
    else:
        raise ValueError(f"ä¸æ˜ãªãƒ¢ãƒ¼ãƒ‰ã§ã™: {mode}")

    return textwrap.dedent(prompt)

# ======================================================
# ğŸ§  LLMå‘¼ã³å‡ºã—ãƒ­ã‚¸ãƒƒã‚¯
# ======================================================

def generate_llm_report(data_summary, mode: str = "customer") -> str:
    """
    LLMã‚’ä½¿ã£ã¦ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã€‚
    data_summary: dict
        {"rfm": DataFrame, "forecast": DataFrame} ã®ã‚ˆã†ãªæ§‹æˆ
    mode: "customer" | "product" | "combined"
    """
    prompt = build_report_prompt(data_summary, mode)

    api_key = os.getenv("GEMINI_API_KEY")
    if not api_key:
        raise ValueError("ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")

    client = genai.Client(api_key=api_key)

    try:
        response = client.models.generate_content(
            model="gemini-2.5-flash",
            contents=prompt
        )
        return response.text

    except Exception as e:
        raise RuntimeError(f"LLMãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
